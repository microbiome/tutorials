<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="author" content="Leo Lahti, Sudarshan Shetty et al. 2019-07-26" />


<title>Core microbiome</title>

<script src="Core_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="Core_files/bootstrap-3.3.6/css/bootstrap.min.css" rel="stylesheet" />
<script src="Core_files/bootstrap-3.3.6/js/bootstrap.min.js"></script>
<script src="Core_files/jqueryui-1.11.4/jquery-ui.min.js"></script>
<script src="Core_files/navigation-1.1/tabsets.js"></script>
<script src="Core_files/navigation-1.1/codefolding.js"></script>
<link href="Core_files/magnific-popup-1.1.0/magnific-popup.css" rel="stylesheet" />
<script src="Core_files/magnific-popup-1.1.0/jquery.magnific-popup.min.js"></script>
<link href="Core_files/readthedown-0.1/readthedown.css" rel="stylesheet" />
<script src="Core_files/readthedown-0.1/readthedown.js"></script>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(title);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; } /* Alert */
code span.an { color: #008000; } /* Annotation */
code span.at { } /* Attribute */
code span.bu { } /* BuiltIn */
code span.cf { color: #0000ff; } /* ControlFlow */
code span.ch { color: #008080; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008000; } /* Comment */
code span.cv { color: #008000; } /* CommentVar */
code span.do { color: #008000; } /* Documentation */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.im { } /* Import */
code span.in { color: #008000; } /* Information */
code span.kw { color: #0000ff; } /* Keyword */
code span.op { } /* Operator */
code span.ot { color: #ff4000; } /* Other */
code span.pp { color: #ff4000; } /* Preprocessor */
code span.sc { color: #008080; } /* SpecialChar */
code span.ss { color: #008080; } /* SpecialString */
code span.st { color: #008080; } /* String */
code span.va { } /* Variable */
code span.vs { color: #008080; } /* VerbatimString */
code span.wa { color: #008000; font-weight: bold; } /* Warning */
</style>


</head>

<body>


<div id="content" data-toggle="wy-nav-shift">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->

<nav id="nav-top" role="navigation" aria-label="top navigation">
    <a role="button" href="#" data-toggle="wy-nav-top"><span class="glyphicon glyphicon-menu-hamburger"></span></a>
</nav>


<div id="header">
<h1 class="title">Core microbiome</h1>
</div>


<div id="table-of-contents">
    <h2><a href="#content">Core microbiome</a></h2>
    <div id="text-table-of-contents">
      <ul>
      <li><a href="#hitchip-data">HITChip Data</a><ul>
      <li><a href="#prevalence-of-taxonomic-groups">Prevalence of taxonomic groups</a></li>
      <li><a href="#core-microbiota-analysis">Core microbiota analysis</a></li>
      <li><a href="#core-abundance-and-diversity">Core abundance and diversity</a></li>
      <li><a href="#core-visualization">Core visualization</a></li>
      <li><a href="#core-line-plots">Core line plots</a></li>
      <li><a href="#core-heatmaps">Core heatmaps</a></li>
      </ul></li>
      <li><a href="#core-microbiota-using-amplicon-data">Core Microbiota using Amplicon data</a><ul>
      <li><a href="#make-phyloseq-object">Make phyloseq object</a></li>
      <li><a href="#core-microbiota-analysis-1">Core microbiota analysis</a></li>
      <li><a href="#core-visualization-1">Core visualization</a></li>
      </ul></li>
      </ul>
    </div>
</div>

<div id="main">
<!--
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{microbiome tutorial - core}
  %\usepackage[utf8]{inputenc}
  %\VignetteEncoding{UTF-8}  
-->
<p>See also related functions for the analysis of rare and variable taxa (rare_members; rare_abundance; rare_members; rare_abundance; low_abundance).</p>
<div id="hitchip-data" class="section level1">
<h1>HITChip Data</h1>
<p>Load example data:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" title="1"><span class="co"># Load data</span></a>
<a class="sourceLine" id="cb1-2" title="2"><span class="kw">library</span>(microbiome)</a>
<a class="sourceLine" id="cb1-3" title="3"><span class="kw">data</span>(peerj32)</a>
<a class="sourceLine" id="cb1-4" title="4"></a>
<a class="sourceLine" id="cb1-5" title="5"><span class="co"># Rename the data</span></a>
<a class="sourceLine" id="cb1-6" title="6">pseq &lt;-<span class="st"> </span>peerj32<span class="op">$</span>phyloseq</a>
<a class="sourceLine" id="cb1-7" title="7"></a>
<a class="sourceLine" id="cb1-8" title="8"><span class="co"># Calculate compositional version of the data</span></a>
<a class="sourceLine" id="cb1-9" title="9"><span class="co"># (relative abundances)</span></a>
<a class="sourceLine" id="cb1-10" title="10">pseq.rel &lt;-<span class="st"> </span>microbiome<span class="op">::</span><span class="kw">transform</span>(pseq, <span class="st">&quot;compositional&quot;</span>)</a></code></pre></div>
<div id="prevalence-of-taxonomic-groups" class="section level2">
<h2>Prevalence of taxonomic groups</h2>
<p>Relative population frequencies; at 1% compositional abundance threshold:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" title="1"><span class="kw">head</span>(<span class="kw">prevalence</span>(pseq.rel, <span class="dt">detection =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">100</span>, <span class="dt">sort =</span> <span class="ot">TRUE</span>))</a></code></pre></div>
<pre><code>## Roseburia intestinalis et rel.     Eubacterium hallii et rel. 
##                      1.0000000                      1.0000000 
##     Clostridium nexile et rel.     Ruminococcus obeum et rel. 
##                      1.0000000                      0.9772727 
##   Coprococcus eutactus et rel.  Ruminococcus lactaris et rel. 
##                      0.9772727                      0.9545455</code></pre>
<p>Absolute population frequencies (sample count):</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" title="1"><span class="kw">head</span>(<span class="kw">prevalence</span>(pseq.rel, <span class="dt">detection =</span> <span class="dv">1</span><span class="op">/</span><span class="dv">100</span>, <span class="dt">sort =</span> <span class="ot">TRUE</span>, <span class="dt">count =</span> <span class="ot">TRUE</span>))</a></code></pre></div>
<pre><code>## Roseburia intestinalis et rel.     Eubacterium hallii et rel. 
##                             44                             44 
##     Clostridium nexile et rel.     Ruminococcus obeum et rel. 
##                             44                             43 
##   Coprococcus eutactus et rel.  Ruminococcus lactaris et rel. 
##                             43                             42</code></pre>
</div>
<div id="core-microbiota-analysis" class="section level2">
<h2>Core microbiota analysis</h2>
<p>If you only need the names of the core taxa, do as follows. This returns the taxa that exceed the given prevalence and detection thresholds.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" title="1">core.taxa.standard &lt;-<span class="st"> </span><span class="kw">core_members</span>(pseq.rel, <span class="dt">detection =</span> <span class="dv">0</span>, <span class="dt">prevalence =</span> <span class="dv">50</span><span class="op">/</span><span class="dv">100</span>)</a></code></pre></div>
<p>A full phyloseq object of the core microbiota is obtained as follows:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" title="1">pseq.core &lt;-<span class="st"> </span><span class="kw">core</span>(pseq.rel, <span class="dt">detection =</span> <span class="dv">0</span>, <span class="dt">prevalence =</span> <span class="fl">.5</span>)</a></code></pre></div>
<p>Retrieving the associated taxa names from the phyloseq object:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" title="1">core.taxa &lt;-<span class="st"> </span><span class="kw">taxa</span>(pseq.core)</a></code></pre></div>
</div>
<div id="core-abundance-and-diversity" class="section level2">
<h2>Core abundance and diversity</h2>
<p>Total core abundance in each sample (sum of abundances of the core members):</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" title="1">core.abundance &lt;-<span class="st"> </span><span class="kw">sample_sums</span>(<span class="kw">core</span>(pseq.rel, <span class="dt">detection =</span> <span class="fl">.01</span>, <span class="dt">prevalence =</span> <span class="fl">.95</span>))</a></code></pre></div>
</div>
<div id="core-visualization" class="section level2">
<h2>Core visualization</h2>
</div>
<div id="core-line-plots" class="section level2">
<h2>Core line plots</h2>
<p>Determine core microbiota across various abundance/prevalence thresholds with the blanket analysis <a href="http://onlinelibrary.wiley.com/doi/10.1111/j.1469-0691.2012.03855.x/abstract">(Salonen et al. CMI, 2012)</a> based on various signal and prevalences.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" title="1"><span class="co"># With compositional (relative) abundances</span></a>
<a class="sourceLine" id="cb10-2" title="2">det &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">20</span>)<span class="op">/</span><span class="dv">100</span></a>
<a class="sourceLine" id="cb10-3" title="3">prevalences &lt;-<span class="st"> </span><span class="kw">seq</span>(.<span class="dv">05</span>, <span class="dv">1</span>, <span class="fl">.05</span>)</a>
<a class="sourceLine" id="cb10-4" title="4"> <span class="co">#ggplot(d) + geom_point(aes(x, y)) + scale_x_continuous(trans=&quot;log10&quot;, limits=c(NA,1))</span></a>
<a class="sourceLine" id="cb10-5" title="5"></a>
<a class="sourceLine" id="cb10-6" title="6"></a>
<a class="sourceLine" id="cb10-7" title="7"><span class="kw">plot_core</span>(pseq.rel, <span class="dt">prevalences =</span> prevalences, <span class="dt">detections =</span> det, <span class="dt">plot.type =</span> <span class="st">&quot;lineplot&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;Relative Abundance (%)&quot;</span>)</a></code></pre></div>
<p><img src="Core_files/figure-html/core2-1.png" width="400px" /></p>
</div>
<div id="core-heatmaps" class="section level2">
<h2>Core heatmaps</h2>
<p>This visualization method has been used for instance in <a href="https://academic.oup.com/femsre/article/doi/10.1093/femsre/fuw045/2979411/Intestinal-microbiome-landscaping-insight-in#58802539">Intestinal microbiome landscaping: Insight in community assemblage and implications for microbial modulation strategies</a>. Shetty et al. <em>FEMS Microbiology Reviews</em> fuw045, 2017.</p>
<p>Note that you can order the taxa on the heatmap with the taxa.order argument.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" title="1"><span class="co"># Core with compositionals:</span></a>
<a class="sourceLine" id="cb11-2" title="2">prevalences &lt;-<span class="st"> </span><span class="kw">seq</span>(.<span class="dv">05</span>, <span class="dv">1</span>, <span class="fl">.05</span>)</a>
<a class="sourceLine" id="cb11-3" title="3">detections &lt;-<span class="st"> </span><span class="dv">10</span><span class="op">^</span><span class="kw">seq</span>(<span class="kw">log10</span>(<span class="fl">1e-3</span>), <span class="kw">log10</span>(.<span class="dv">2</span>), <span class="dt">length =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb11-4" title="4"></a>
<a class="sourceLine" id="cb11-5" title="5"><span class="co"># Also define gray color palette</span></a>
<a class="sourceLine" id="cb11-6" title="6">gray &lt;-<span class="st"> </span><span class="kw">gray</span>(<span class="kw">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dt">length=</span><span class="dv">5</span>))</a>
<a class="sourceLine" id="cb11-7" title="7">p &lt;-<span class="st"> </span><span class="kw">plot_core</span>(pseq.rel, <span class="dt">plot.type =</span> <span class="st">&quot;heatmap&quot;</span>, <span class="dt">colours =</span> gray,</a>
<a class="sourceLine" id="cb11-8" title="8">    <span class="dt">prevalences =</span> prevalences, <span class="dt">detections =</span> detections) <span class="op">+</span></a>
<a class="sourceLine" id="cb11-9" title="9"><span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Detection Threshold (Relative Abundance (%))&quot;</span>)</a>
<a class="sourceLine" id="cb11-10" title="10"><span class="kw">print</span>(p)    </a>
<a class="sourceLine" id="cb11-11" title="11"></a>
<a class="sourceLine" id="cb11-12" title="12"></a>
<a class="sourceLine" id="cb11-13" title="13"><span class="co"># Core with absolute counts and horizontal view:</span></a>
<a class="sourceLine" id="cb11-14" title="14"><span class="co"># and minimum population prevalence (given as percentage)</span></a>
<a class="sourceLine" id="cb11-15" title="15">detections &lt;-<span class="st"> </span><span class="dv">10</span><span class="op">^</span><span class="kw">seq</span>(<span class="kw">log10</span>(<span class="dv">1</span>), <span class="kw">log10</span>(<span class="kw">max</span>(<span class="kw">abundances</span>(pseq))<span class="op">/</span><span class="dv">10</span>), <span class="dt">length =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb11-16" title="16"></a>
<a class="sourceLine" id="cb11-17" title="17"><span class="kw">library</span>(RColorBrewer)</a>
<a class="sourceLine" id="cb11-18" title="18">p &lt;-<span class="st"> </span><span class="kw">plot_core</span>(pseq, <span class="dt">plot.type =</span> <span class="st">&quot;heatmap&quot;</span>, </a>
<a class="sourceLine" id="cb11-19" title="19">             <span class="dt">prevalences =</span> prevalences,</a>
<a class="sourceLine" id="cb11-20" title="20">             <span class="dt">detections =</span> detections,</a>
<a class="sourceLine" id="cb11-21" title="21">         <span class="dt">colours =</span> <span class="kw">rev</span>(<span class="kw">brewer.pal</span>(<span class="dv">5</span>, <span class="st">&quot;Spectral&quot;</span>)),</a>
<a class="sourceLine" id="cb11-22" title="22">         <span class="dt">min.prevalence =</span> <span class="fl">.2</span>, <span class="dt">horizontal =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb11-23" title="23"><span class="kw">print</span>(p)</a></code></pre></div>
<p><img src="Core_files/figure-html/core-example3-1.png" width="200px" /><img src="Core_files/figure-html/core-example3-2.png" width="200px" /></p>
</div>
</div>
<div id="core-microbiota-using-amplicon-data" class="section level1">
<h1>Core Microbiota using Amplicon data</h1>
<div id="make-phyloseq-object" class="section level2">
<h2>Make phyloseq object</h2>
<p>This tutorial is useful for analysis of output files from <a href="https://www.mothur.org/">(Mothur)</a>, <a href="https://qiime2.org/">(QIIME or QIIME2)</a> or any tool that gives a biom file as output. There is also a simple way to read comma seperated (*.csv) files.</p>
<p>Simple comma seperated files:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" title="1"><span class="kw">library</span>(microbiome)</a>
<a class="sourceLine" id="cb12-2" title="2"></a>
<a class="sourceLine" id="cb12-3" title="3"></a>
<a class="sourceLine" id="cb12-4" title="4">otu.file &lt;-</a>
<a class="sourceLine" id="cb12-5" title="5"><span class="st">    </span><span class="kw">system.file</span>(<span class="st">&quot;extdata/qiita1629_otu_table.csv&quot;</span>,</a>
<a class="sourceLine" id="cb12-6" title="6">        <span class="dt">package=</span><span class="st">&#39;microbiome&#39;</span>)</a>
<a class="sourceLine" id="cb12-7" title="7"></a>
<a class="sourceLine" id="cb12-8" title="8">tax.file &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata/qiita1629_taxonomy_table.csv&quot;</span>,</a>
<a class="sourceLine" id="cb12-9" title="9">        <span class="dt">package=</span><span class="st">&#39;microbiome&#39;</span>)</a>
<a class="sourceLine" id="cb12-10" title="10"></a>
<a class="sourceLine" id="cb12-11" title="11">meta.file &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&quot;extdata/qiita1629_mapping_subset.csv&quot;</span>,</a>
<a class="sourceLine" id="cb12-12" title="12">        <span class="dt">package=</span><span class="st">&#39;microbiome&#39;</span>)</a>
<a class="sourceLine" id="cb12-13" title="13"></a>
<a class="sourceLine" id="cb12-14" title="14">pseq.csv &lt;-<span class="st"> </span><span class="kw">read_phyloseq</span>(</a>
<a class="sourceLine" id="cb12-15" title="15">          <span class="dt">otu.file=</span>otu.file, </a>
<a class="sourceLine" id="cb12-16" title="16">          <span class="dt">taxonomy.file=</span>tax.file, </a>
<a class="sourceLine" id="cb12-17" title="17">          <span class="dt">metadata.file=</span>meta.file, <span class="dt">type =</span> <span class="st">&quot;simple&quot;</span>)</a></code></pre></div>
<p>Biom file:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" title="1"><span class="co"># Read the biom file</span></a>
<a class="sourceLine" id="cb13-2" title="2">biom.file &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb13-3" title="3"><span class="st">  </span><span class="kw">system.file</span>(<span class="st">&quot;extdata/qiita1629.biom&quot;</span>, </a>
<a class="sourceLine" id="cb13-4" title="4">              <span class="dt">package =</span> <span class="st">&quot;microbiome&quot;</span>)</a>
<a class="sourceLine" id="cb13-5" title="5"></a>
<a class="sourceLine" id="cb13-6" title="6"><span class="co"># Read the mapping/metadata file</span></a>
<a class="sourceLine" id="cb13-7" title="7"> meta.file &lt;-<span class="st"> </span></a>
<a class="sourceLine" id="cb13-8" title="8"><span class="st">  </span><span class="kw">system.file</span>(<span class="st">&quot;extdata/qiita1629_mapping.csv&quot;</span>, </a>
<a class="sourceLine" id="cb13-9" title="9">              <span class="dt">package =</span> <span class="st">&quot;microbiome&quot;</span>)</a>
<a class="sourceLine" id="cb13-10" title="10"><span class="co"># Make phyloseq object</span></a>
<a class="sourceLine" id="cb13-11" title="11">pseq.biom &lt;-<span class="st"> </span><span class="kw">read_phyloseq</span>(<span class="dt">otu.file =</span> biom.file, </a>
<a class="sourceLine" id="cb13-12" title="12">                         <span class="dt">metadata.file =</span> meta.file, </a>
<a class="sourceLine" id="cb13-13" title="13">                         <span class="dt">taxonomy.file =</span> <span class="ot">NULL</span>, <span class="dt">type =</span> <span class="st">&quot;biom&quot;</span>)</a></code></pre></div>
<p>Mothur shared OTUs and Consensus Taxonomy:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" title="1">otu.file &lt;-<span class="st"> </span><span class="kw">system.file</span>(</a>
<a class="sourceLine" id="cb14-2" title="2"> <span class="st">&quot;extdata/Baxter_FITs_Microbiome_2016_fit.final.tx.1.subsample.shared&quot;</span>,</a>
<a class="sourceLine" id="cb14-3" title="3">    <span class="dt">package=</span><span class="st">&#39;microbiome&#39;</span>)</a>
<a class="sourceLine" id="cb14-4" title="4"></a>
<a class="sourceLine" id="cb14-5" title="5">tax.file &lt;-<span class="st"> </span><span class="kw">system.file</span>(</a>
<a class="sourceLine" id="cb14-6" title="6"> <span class="st">&quot;extdata/Baxter_FITs_Microbiome_2016_fit.final.tx.1.cons.taxonomy&quot;</span>,</a>
<a class="sourceLine" id="cb14-7" title="7">    <span class="dt">package=</span><span class="st">&#39;microbiome&#39;</span>)</a>
<a class="sourceLine" id="cb14-8" title="8"></a>
<a class="sourceLine" id="cb14-9" title="9">meta.file &lt;-<span class="st"> </span><span class="kw">system.file</span>(</a>
<a class="sourceLine" id="cb14-10" title="10"> <span class="st">&quot;extdata/Baxter_FITs_Microbiome_2016_mapping.csv&quot;</span>,</a>
<a class="sourceLine" id="cb14-11" title="11">    <span class="dt">package=</span><span class="st">&#39;microbiome&#39;</span>)</a>
<a class="sourceLine" id="cb14-12" title="12"> </a>
<a class="sourceLine" id="cb14-13" title="13">pseq.mothur &lt;-<span class="st"> </span><span class="kw">read_phyloseq</span>(<span class="dt">otu.file=</span>otu.file,</a>
<a class="sourceLine" id="cb14-14" title="14">        <span class="dt">taxonomy.file =</span>tax.file,</a>
<a class="sourceLine" id="cb14-15" title="15">        <span class="dt">metadata.file=</span>meta.file, <span class="dt">type =</span> <span class="st">&quot;mothur&quot;</span>)</a>
<a class="sourceLine" id="cb14-16" title="16"><span class="kw">print</span>(pseq.mothur)</a></code></pre></div>
<p>Now, we proceed to core microbiota analysis.</p>
</div>
<div id="core-microbiota-analysis-1" class="section level2">
<h2>Core microbiota analysis</h2>
<p>Here the data from <a href="http://www.nature.com/articles/nmicrobiol20174">(Halfvarson et al. Nature Microbiology 2, 2017)</a> will be used and only healthy samples will be included.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" title="1"><span class="co"># check the data </span></a>
<a class="sourceLine" id="cb15-2" title="2"><span class="kw">print</span>(pseq.biom) </a>
<a class="sourceLine" id="cb15-3" title="3"></a>
<a class="sourceLine" id="cb15-4" title="4"><span class="co"># Filter the data to include only healthy subjects</span></a>
<a class="sourceLine" id="cb15-5" title="5">pseq<span class="fl">.1</span> &lt;-<span class="st"> </span><span class="kw">subset_samples</span>(pseq.biom, ibd_subtype <span class="op">==</span><span class="st"> &quot;HC&quot;</span> <span class="op">&amp;</span><span class="st"> </span>timepoint <span class="op">==</span><span class="st"> &quot;1&quot;</span>) </a>
<a class="sourceLine" id="cb15-6" title="6"><span class="kw">print</span>(pseq<span class="fl">.1</span>)</a>
<a class="sourceLine" id="cb15-7" title="7"><span class="co"># keep only taxa with positive sums</span></a>
<a class="sourceLine" id="cb15-8" title="8">pseq<span class="fl">.2</span> &lt;-<span class="st"> </span><span class="kw">prune_taxa</span>(<span class="kw">taxa_sums</span>(pseq<span class="fl">.1</span>) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>, pseq<span class="fl">.1</span>)</a>
<a class="sourceLine" id="cb15-9" title="9"></a>
<a class="sourceLine" id="cb15-10" title="10"><span class="kw">print</span>(pseq<span class="fl">.2</span>)</a>
<a class="sourceLine" id="cb15-11" title="11"></a>
<a class="sourceLine" id="cb15-12" title="12"><span class="co"># Calculate compositional version of the data</span></a>
<a class="sourceLine" id="cb15-13" title="13"><span class="co"># (relative abundances)</span></a>
<a class="sourceLine" id="cb15-14" title="14">pseq.rel &lt;-<span class="st"> </span>microbiome<span class="op">::</span><span class="kw">transform</span>(pseq<span class="fl">.2</span>, <span class="st">&quot;compositional&quot;</span>)</a></code></pre></div>
<div id="prevalence-of-taxonomic-groups-1" class="section level3">
<h3>Prevalence of taxonomic groups</h3>
<p>Relative population frequencies; at 1% compositional abundance threshold:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" title="1"><span class="kw">head</span>(<span class="kw">prevalence</span>(pseq.rel, <span class="dt">detection =</span> <span class="dv">1</span>, <span class="dt">sort =</span> <span class="ot">TRUE</span>))</a></code></pre></div>
<p>We can see that only OTU ids are listed with no taxonomic information. Absolute population frequencies (sample count):</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" title="1"><span class="kw">head</span>(<span class="kw">prevalence</span>(pseq.rel, <span class="dt">detection =</span> <span class="dv">1</span>, <span class="dt">sort =</span> <span class="ot">TRUE</span>, <span class="dt">count =</span> <span class="ot">TRUE</span>))</a></code></pre></div>
</div>
<div id="core-microbiota-analysis-2" class="section level3">
<h3>Core microbiota analysis</h3>
<p>If you only need the names of the core taxa, do as follows. This returns the taxa that exceed the given prevalence and detection thresholds.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" title="1">core.taxa.standard &lt;-<span class="st"> </span><span class="kw">core_members</span>(pseq.rel, <span class="dt">detection =</span> <span class="dv">0</span>, <span class="dt">prevalence =</span> <span class="dv">50</span><span class="op">/</span><span class="dv">100</span>)</a></code></pre></div>
<p>A full phyloseq object of the core microbiota is obtained as follows:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" title="1">pseq.core &lt;-<span class="st"> </span><span class="kw">core</span>(pseq.rel, <span class="dt">detection =</span> <span class="dv">0</span>, <span class="dt">prevalence =</span> <span class="fl">.5</span>)</a></code></pre></div>
<p>Retrieving the associated taxa names from the phyloseq object:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" title="1">core.taxa &lt;-<span class="st"> </span><span class="kw">taxa</span>(pseq.core)</a>
<a class="sourceLine" id="cb20-2" title="2"><span class="kw">class</span>(core.taxa)</a>
<a class="sourceLine" id="cb20-3" title="3"><span class="co"># get the taxonomy data</span></a>
<a class="sourceLine" id="cb20-4" title="4">tax.mat &lt;-<span class="st"> </span><span class="kw">tax_table</span>(pseq.core)</a>
<a class="sourceLine" id="cb20-5" title="5">tax.df &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(tax.mat)</a>
<a class="sourceLine" id="cb20-6" title="6"></a>
<a class="sourceLine" id="cb20-7" title="7"><span class="co"># add the OTus to last column</span></a>
<a class="sourceLine" id="cb20-8" title="8">tax.df<span class="op">$</span>OTU &lt;-<span class="st"> </span><span class="kw">rownames</span>(tax.df)</a>
<a class="sourceLine" id="cb20-9" title="9"></a>
<a class="sourceLine" id="cb20-10" title="10"><span class="co"># select taxonomy of only </span></a>
<a class="sourceLine" id="cb20-11" title="11"><span class="co"># those OTUs that are core memebers based on the thresholds that were used.</span></a>
<a class="sourceLine" id="cb20-12" title="12">core.taxa.class &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">filter</span>(tax.df, <span class="kw">rownames</span>(tax.df) <span class="op">%in%</span><span class="st"> </span>core.taxa)</a>
<a class="sourceLine" id="cb20-13" title="13">knitr<span class="op">::</span><span class="kw">kable</span>(<span class="kw">head</span>(core.taxa.class))</a></code></pre></div>
</div>
<div id="core-abundance-and-diversity-1" class="section level3">
<h3>Core abundance and diversity</h3>
<p>Total core abundance in each sample (sum of abundances of the core members):</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" title="1">core.abundance &lt;-<span class="st"> </span><span class="kw">sample_sums</span>(<span class="kw">core</span>(pseq.rel, <span class="dt">detection =</span> <span class="fl">.001</span>, <span class="dt">prevalence =</span> <span class="fl">.95</span>))</a></code></pre></div>
</div>
</div>
<div id="core-visualization-1" class="section level2">
<h2>Core visualization</h2>
<div id="core-line-plots-1" class="section level3">
<h3>Core line plots</h3>
<p>Determine core microbiota across various abundance/prevalence thresholds with the blanket analysis <a href="http://onlinelibrary.wiley.com/doi/10.1111/j.1469-0691.2012.03855.x/abstract">(Salonen et al. CMI, 2012)</a> based on various signal and prevalences.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" title="1"><span class="co"># With compositional (relative) abundances</span></a>
<a class="sourceLine" id="cb22-2" title="2">det &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">0</span>, <span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">20</span>)<span class="op">/</span><span class="dv">100</span></a>
<a class="sourceLine" id="cb22-3" title="3">prevalences &lt;-<span class="st"> </span><span class="kw">seq</span>(.<span class="dv">05</span>, <span class="dv">1</span>, <span class="fl">.05</span>)</a>
<a class="sourceLine" id="cb22-4" title="4"><span class="kw">plot_core</span>(pseq.rel, <span class="dt">prevalences =</span> prevalences, <span class="dt">detections =</span> det, <span class="dt">plot.type =</span> <span class="st">&quot;lineplot&quot;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">xlab</span>(<span class="st">&quot;Relative Abundance (%)&quot;</span>)</a></code></pre></div>
</div>
<div id="core-heatmaps-1" class="section level3">
<h3>Core heatmaps</h3>
<p>This visualization method has been used for instance in <a href="https://academic.oup.com/femsre/article/doi/10.1093/femsre/fuw045/2979411/Intestinal-microbiome-landscaping-insight-in#58802539">Intestinal microbiome landscaping: Insight in community assemblage and implications for microbial modulation strategies</a>. Shetty et al. <em>FEMS Microbiology Reviews</em> fuw045, 2017.</p>
<p>Note that you can order the taxa on the heatmap with the order.taxa argument.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" title="1"><span class="co"># Core with compositionals:</span></a>
<a class="sourceLine" id="cb23-2" title="2">prevalences &lt;-<span class="st"> </span><span class="kw">seq</span>(.<span class="dv">05</span>, <span class="dv">1</span>, <span class="fl">.05</span>)</a>
<a class="sourceLine" id="cb23-3" title="3">detections &lt;-<span class="st"> </span><span class="dv">10</span><span class="op">^</span><span class="kw">seq</span>(<span class="kw">log10</span>(<span class="fl">1e-5</span>), <span class="kw">log10</span>(.<span class="dv">2</span>), <span class="dt">length =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb23-4" title="4"></a>
<a class="sourceLine" id="cb23-5" title="5"><span class="co"># Also define gray color palette</span></a>
<a class="sourceLine" id="cb23-6" title="6">gray &lt;-<span class="st"> </span><span class="kw">gray</span>(<span class="kw">seq</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dt">length=</span><span class="dv">5</span>))</a>
<a class="sourceLine" id="cb23-7" title="7">p &lt;-<span class="st"> </span><span class="kw">plot_core</span>(pseq.rel, <span class="dt">plot.type =</span> <span class="st">&quot;heatmap&quot;</span>, <span class="dt">colours =</span> gray,</a>
<a class="sourceLine" id="cb23-8" title="8">    <span class="dt">prevalences =</span> prevalences, <span class="dt">detections =</span> detections, <span class="dt">min.prevalence =</span> <span class="fl">.5</span>) <span class="op">+</span></a>
<a class="sourceLine" id="cb23-9" title="9"><span class="st">    </span><span class="kw">xlab</span>(<span class="st">&quot;Detection Threshold (Relative Abundance (%))&quot;</span>)</a>
<a class="sourceLine" id="cb23-10" title="10"><span class="kw">print</span>(p)    </a>
<a class="sourceLine" id="cb23-11" title="11"></a>
<a class="sourceLine" id="cb23-12" title="12"></a>
<a class="sourceLine" id="cb23-13" title="13"><span class="co"># Same with the viridis color palette</span></a>
<a class="sourceLine" id="cb23-14" title="14"><span class="co"># color-blind friendly and uniform</span></a>
<a class="sourceLine" id="cb23-15" title="15"><span class="co"># options: viridis, magma, plasma, inferno</span></a>
<a class="sourceLine" id="cb23-16" title="16"><span class="co"># https://cran.r-project.org/web/packages/viridis/vignettes/intro-to-viridis.html</span></a>
<a class="sourceLine" id="cb23-17" title="17"><span class="co"># Also discrete=TRUE versions available</span></a>
<a class="sourceLine" id="cb23-18" title="18"><span class="kw">library</span>(viridis)</a>
<a class="sourceLine" id="cb23-19" title="19"><span class="kw">print</span>(p <span class="op">+</span><span class="st"> </span><span class="kw">scale_fill_viridis</span>())</a></code></pre></div>
<p>As it can be seen, we see only OTu IDs and this may not be useful to interpret the data. We need to repreoccess this figure to include taxonomic information. We can do this as follows:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" title="1"><span class="kw">library</span>(RColorBrewer)</a>
<a class="sourceLine" id="cb24-2" title="2"><span class="kw">library</span>(knitr)</a>
<a class="sourceLine" id="cb24-3" title="3"><span class="co"># Core with absolute counts and vertical view:</span></a>
<a class="sourceLine" id="cb24-4" title="4"><span class="co"># and minimum population prevalence (given as percentage)</span></a>
<a class="sourceLine" id="cb24-5" title="5">detections &lt;-<span class="st"> </span><span class="dv">10</span><span class="op">^</span><span class="kw">seq</span>(<span class="kw">log10</span>(<span class="dv">1</span>), <span class="kw">log10</span>(<span class="kw">max</span>(<span class="kw">abundances</span>(pseq<span class="fl">.2</span>))<span class="op">/</span><span class="dv">10</span>), <span class="dt">length =</span> <span class="dv">10</span>)</a>
<a class="sourceLine" id="cb24-6" title="6"></a>
<a class="sourceLine" id="cb24-7" title="7">healthycore &lt;-<span class="st"> </span><span class="kw">plot_core</span>(pseq<span class="fl">.2</span>, <span class="dt">plot.type =</span> <span class="st">&quot;heatmap&quot;</span>, </a>
<a class="sourceLine" id="cb24-8" title="8">             <span class="dt">prevalences =</span> prevalences,</a>
<a class="sourceLine" id="cb24-9" title="9">             <span class="dt">detections =</span> detections,</a>
<a class="sourceLine" id="cb24-10" title="10">         <span class="dt">colours =</span> <span class="kw">rev</span>(<span class="kw">brewer.pal</span>(<span class="dv">5</span>, <span class="st">&quot;Spectral&quot;</span>)),</a>
<a class="sourceLine" id="cb24-11" title="11">         <span class="dt">min.prevalence =</span> <span class="fl">.90</span>, <span class="dt">horizontal =</span> F)</a>
<a class="sourceLine" id="cb24-12" title="12"><span class="co"># get the data used for plotting </span></a>
<a class="sourceLine" id="cb24-13" title="13">df &lt;-<span class="st"> </span>healthycore<span class="op">$</span>data </a>
<a class="sourceLine" id="cb24-14" title="14"></a>
<a class="sourceLine" id="cb24-15" title="15"><span class="co"># get the list of OTUs</span></a>
<a class="sourceLine" id="cb24-16" title="16">list &lt;-<span class="st"> </span>df<span class="op">$</span>Taxa </a>
<a class="sourceLine" id="cb24-17" title="17"></a>
<a class="sourceLine" id="cb24-18" title="18"><span class="co"># check the OTU ids</span></a>
<a class="sourceLine" id="cb24-19" title="19"><span class="co"># print(list) </span></a>
<a class="sourceLine" id="cb24-20" title="20"></a>
<a class="sourceLine" id="cb24-21" title="21"><span class="co"># get the taxonomy data</span></a>
<a class="sourceLine" id="cb24-22" title="22">tax &lt;-<span class="st"> </span><span class="kw">tax_table</span>(pseq<span class="fl">.2</span>)</a>
<a class="sourceLine" id="cb24-23" title="23">tax &lt;-<span class="st"> </span><span class="kw">as.data.frame</span>(tax)</a>
<a class="sourceLine" id="cb24-24" title="24"></a>
<a class="sourceLine" id="cb24-25" title="25"><span class="co"># add the OTus to last column</span></a>
<a class="sourceLine" id="cb24-26" title="26">tax<span class="op">$</span>OTU &lt;-<span class="st"> </span><span class="kw">rownames</span>(tax)</a>
<a class="sourceLine" id="cb24-27" title="27"></a>
<a class="sourceLine" id="cb24-28" title="28"><span class="co"># select taxonomy of only </span></a>
<a class="sourceLine" id="cb24-29" title="29"><span class="co"># those OTUs that are used in the plot</span></a>
<a class="sourceLine" id="cb24-30" title="30">tax2 &lt;-<span class="st"> </span>dplyr<span class="op">::</span><span class="kw">filter</span>(tax, <span class="kw">rownames</span>(tax) <span class="op">%in%</span><span class="st"> </span>list) </a>
<a class="sourceLine" id="cb24-31" title="31"></a>
<a class="sourceLine" id="cb24-32" title="32"><span class="co"># head(tax2)</span></a>
<a class="sourceLine" id="cb24-33" title="33"></a>
<a class="sourceLine" id="cb24-34" title="34"><span class="co"># We will merege all the column into one except the Doamin as all is bacteria in this case</span></a>
<a class="sourceLine" id="cb24-35" title="35">tax.unit &lt;-<span class="st"> </span>tidyr<span class="op">::</span><span class="kw">unite</span>(tax2, Taxa_level,<span class="kw">c</span>(<span class="st">&quot;Domain&quot;</span>, <span class="st">&quot;Phylum&quot;</span>, <span class="st">&quot;Class&quot;</span>, <span class="st">&quot;Order&quot;</span>, <span class="st">&quot;Family&quot;</span>, <span class="st">&quot;Genus&quot;</span>, <span class="st">&quot;Species&quot;</span>, <span class="st">&quot;OTU&quot;</span>), <span class="dt">sep =</span> <span class="st">&quot;_;&quot;</span>, <span class="dt">remove =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb24-36" title="36"></a>
<a class="sourceLine" id="cb24-37" title="37">tax.unit<span class="op">$</span>Taxa_level &lt;-<span class="st"> </span><span class="kw">gsub</span>(<span class="dt">pattern=</span><span class="st">&quot;[a-z]__&quot;</span>,<span class="dt">replacement=</span><span class="st">&quot;&quot;</span>, tax.unit<span class="op">$</span>Taxa_level)</a>
<a class="sourceLine" id="cb24-38" title="38"></a>
<a class="sourceLine" id="cb24-39" title="39"><span class="co"># add this new information into the plot data df</span></a>
<a class="sourceLine" id="cb24-40" title="40"></a>
<a class="sourceLine" id="cb24-41" title="41">df<span class="op">$</span>Taxa &lt;-<span class="st"> </span>tax.unit<span class="op">$</span>Taxa_level</a>
<a class="sourceLine" id="cb24-42" title="42"></a>
<a class="sourceLine" id="cb24-43" title="43"><span class="co"># you can see now we have the taxonomic information</span></a>
<a class="sourceLine" id="cb24-44" title="44">knitr<span class="op">::</span><span class="kw">kable</span>(<span class="kw">head</span>(df))</a>
<a class="sourceLine" id="cb24-45" title="45"></a>
<a class="sourceLine" id="cb24-46" title="46"><span class="co"># replace the data in the plot object</span></a>
<a class="sourceLine" id="cb24-47" title="47">healthycore<span class="op">$</span>data &lt;-<span class="st"> </span>df</a>
<a class="sourceLine" id="cb24-48" title="48"></a>
<a class="sourceLine" id="cb24-49" title="49"><span class="kw">plot</span>(healthycore <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">axis.text.y =</span> <span class="kw">element_text</span>(<span class="dt">face=</span><span class="st">&quot;italic&quot;</span>)))</a></code></pre></div>
</div>
</div>
</div>
</div>


</div>

<div id="postamble" data-toggle="wy-nav-shift" class="status">
<p class="author"><span class="glyphicon glyphicon-user"></span> Leo Lahti, Sudarshan Shetty et al. 2019-07-26</p>
</div>


<script>
$(document).ready(function () {
 	 	$('#content img')
 	  .addClass("image-thumb");
      $('#content img')
 	  .addClass("image-lb");
  $('#content').magnificPopup({
	      type:'image',
	      closeOnContentClick: false,
	      closeBtnInside: false,
	      delegate: 'img',
	      gallery: {enabled: true },
	      image: {
	        verticalFit: true,
          titleSrc: 'alt'
	      }
 	    });
 	});
</script>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
